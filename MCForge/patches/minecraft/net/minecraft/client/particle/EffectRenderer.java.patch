--- ../src-base/minecraft/net/minecraft/client/particle/EffectRenderer.java
+++ ../src-work/minecraft/net/minecraft/client/particle/EffectRenderer.java
@@ -1,11 +1,16 @@
 package net.minecraft.client.particle;
 
-import com.google.common.collect.Lists;
-import com.google.common.collect.Maps;
+import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
+import java.util.Map.Entry;
 import java.util.Random;
 import java.util.concurrent.Callable;
+
+import com.google.common.collect.Lists;
+import com.google.common.collect.Maps;
+
+import net.mattbenson.Wrapper;
 import net.minecraft.block.Block;
 import net.minecraft.block.material.Material;
 import net.minecraft.block.state.IBlockState;
@@ -19,24 +24,28 @@
 import net.minecraft.crash.CrashReport;
 import net.minecraft.crash.CrashReportCategory;
 import net.minecraft.entity.Entity;
+import net.minecraft.src.Config;
 import net.minecraft.util.BlockPos;
 import net.minecraft.util.EnumFacing;
 import net.minecraft.util.EnumParticleTypes;
 import net.minecraft.util.MathHelper;
+import net.minecraft.util.MovingObjectPosition;
 import net.minecraft.util.ReportedException;
 import net.minecraft.util.ResourceLocation;
 import net.minecraft.world.World;
-import net.minecraftforge.fml.relauncher.Side;
-import net.minecraftforge.fml.relauncher.SideOnly;
+import net.optifine.reflect.Reflector;
 
-@SideOnly(Side.CLIENT)
 public class EffectRenderer
 {
     private static final ResourceLocation field_110737_b = new ResourceLocation("textures/particle/particles.png");
+
+    /** Reference to the World object. */
     protected World field_78878_a;
     private List<EntityFX>[][] field_78876_b = new List[4][];
     private List<EntityParticleEmitter> field_178933_d = Lists.<EntityParticleEmitter>newArrayList();
     private TextureManager field_78877_c;
+
+    /** RNG. */
     private Random field_78875_d = new Random();
     private Map<Integer, IParticleFactory> field_178932_g = Maps.<Integer, IParticleFactory>newHashMap();
 
@@ -113,10 +122,22 @@
         this.field_178933_d.add(new EntityParticleEmitter(this.field_78878_a, p_178926_1_, p_178926_2_));
     }
 
+    /**
+     * Spawns the relevant particle according to the particle id.
+     *  
+     * @param particleId The id of the particle
+     */
     public EntityFX func_178927_a(int p_178927_1_, double p_178927_2_, double p_178927_4_, double p_178927_6_, double p_178927_8_, double p_178927_10_, double p_178927_12_, int... p_178927_14_)
     {
-        IParticleFactory iparticlefactory = (IParticleFactory)this.field_178932_g.get(Integer.valueOf(p_178927_1_));
-
+    	//TODO: Falcun
+    	for(EnumParticleTypes type : Wrapper.getInstance().getParticles()) {
+    		if(type.func_179348_c() == p_178927_1_) {
+    			return null;
+    		}
+    	}
+    	
+    	IParticleFactory iparticlefactory = (IParticleFactory)this.field_178932_g.get(Integer.valueOf(p_178927_1_));
+        
         if (iparticlefactory != null)
         {
             EntityFX entityfx = iparticlefactory.func_178902_a(p_178927_1_, this.field_78878_a, p_178927_2_, p_178927_4_, p_178927_6_, p_178927_8_, p_178927_10_, p_178927_12_, p_178927_14_);
@@ -133,15 +154,41 @@
 
     public void func_78873_a(EntityFX p_78873_1_)
     {
-        int i = p_78873_1_.func_70537_b();
-        int j = p_78873_1_.func_174838_j() != 1.0F ? 0 : 1;
-
-        if (this.field_78876_b[i][j].size() >= 4000)
+        if (p_78873_1_ != null)
         {
-            this.field_78876_b[i][j].remove(0);
-        }
+        	//TODO: Falcun
+        	int id = -1;
+        	
+        	String effectName = p_78873_1_.getClass().getSimpleName();
+        	
+        	for(Entry<Integer, IParticleFactory> entry : field_178932_g.entrySet()) {
+        		String name = entry.getValue().getClass().getName();
+        		
+        		if(name.indexOf(effectName) >= 0) {
+        			id = entry.getKey();
+        			break;
+        		}
+        	}
+        	
+        	for(EnumParticleTypes type : Wrapper.getInstance().getParticles()) {
+        		if(type.func_179348_c() == id) {
+        			return;
+        		}
+        	}
+        	
+            if (!(p_78873_1_ instanceof EntityFirework.SparkFX) || Config.isFireworkParticles())
+            {
+                int i = p_78873_1_.func_70537_b();
+                int j = p_78873_1_.func_174838_j() != 1.0F ? 0 : 1;
 
-        this.field_78876_b[i][j].add(p_78873_1_);
+                if (this.field_78876_b[i][j].size() >= 4000)
+                {
+                    this.field_78876_b[i][j].remove(0);
+                }
+
+                this.field_78876_b[i][j].add(p_78873_1_);
+            }
+        }
     }
 
     public void func_78868_a()
@@ -176,19 +223,40 @@
 
     private void func_178925_a(List<EntityFX> p_178925_1_)
     {
-        List<EntityFX> list = Lists.<EntityFX>newArrayList();
+        List<EntityFX> list = Lists.newArrayList();
+        long i = System.currentTimeMillis();
+        int j = p_178925_1_.size();
 
-        for (int i = 0; i < p_178925_1_.size(); ++i)
+        for (int k = 0; k < p_178925_1_.size(); ++k)
         {
-            EntityFX entityfx = (EntityFX)p_178925_1_.get(i);
+            EntityFX entityfx = p_178925_1_.get(k);
             this.func_178923_d(entityfx);
 
             if (entityfx.field_70128_L)
             {
                 list.add(entityfx);
             }
+
+            --j;
+
+            if (System.currentTimeMillis() > i + 20L)
+            {
+                break;
+            }
         }
 
+        if (j > 0)
+        {
+            int l = j;
+
+            for (Iterator iterator = p_178925_1_.iterator(); iterator.hasNext() && l > 0; --l)
+            {
+                EntityFX entityfx1 = (EntityFX)iterator.next();
+                entityfx1.func_70106_y();
+                iterator.remove();
+            }
+        }
+
         p_178925_1_.removeAll(list);
     }
 
@@ -221,6 +289,9 @@
         }
     }
 
+    /**
+     * Renders all current particles. Args player, partialTickTime
+     */
     public void func_78874_a(Entity p_78874_1_, float p_78874_2_)
     {
         float f = ActiveRenderInfo.func_178808_b();
@@ -248,6 +319,7 @@
                         case 0:
                             GlStateManager.func_179132_a(false);
                             break;
+
                         case 1:
                             GlStateManager.func_179132_a(true);
                     }
@@ -258,6 +330,7 @@
                         default:
                             this.field_78877_c.func_110577_a(field_110737_b);
                             break;
+
                         case 1:
                             this.field_78877_c.func_110577_a(TextureMap.field_110575_b);
                     }
@@ -270,7 +343,7 @@
                     for (int k = 0; k < this.field_78876_b[i][j].size(); ++k)
                     {
                         final EntityFX entityfx = (EntityFX)this.field_78876_b[i][j].get(k);
-
+                        
                         try
                         {
                             entityfx.func_180434_a(worldrenderer, p_78874_1_, p_78874_2_, f, f4, f1, f2, f3);
@@ -351,20 +424,32 @@
 
     public void func_180533_a(BlockPos p_180533_1_, IBlockState p_180533_2_)
     {
-        if (p_180533_2_.func_177230_c().func_149688_o() != Material.field_151579_a)
+        boolean flag;
+
+        if (Reflector.ForgeBlock_addDestroyEffects.exists() && Reflector.ForgeBlock_isAir.exists())
         {
+            Block block = p_180533_2_.func_177230_c();
+            flag = !Reflector.callBoolean(block, Reflector.ForgeBlock_isAir, new Object[] {this.field_78878_a, p_180533_1_}) && !Reflector.callBoolean(block, Reflector.ForgeBlock_addDestroyEffects, new Object[] {this.field_78878_a, p_180533_1_, this});
+        }
+        else
+        {
+            flag = p_180533_2_.func_177230_c().func_149688_o() != Material.field_151579_a;
+        }
+
+        if (flag)
+        {
             p_180533_2_ = p_180533_2_.func_177230_c().func_176221_a(p_180533_2_, this.field_78878_a, p_180533_1_);
-            int i = 4;
+            int l = 4;
 
-            for (int j = 0; j < i; ++j)
+            for (int i = 0; i < l; ++i)
             {
-                for (int k = 0; k < i; ++k)
+                for (int j = 0; j < l; ++j)
                 {
-                    for (int l = 0; l < i; ++l)
+                    for (int k = 0; k < l; ++k)
                     {
-                        double d0 = (double)p_180533_1_.func_177958_n() + ((double)j + 0.5D) / (double)i;
-                        double d1 = (double)p_180533_1_.func_177956_o() + ((double)k + 0.5D) / (double)i;
-                        double d2 = (double)p_180533_1_.func_177952_p() + ((double)l + 0.5D) / (double)i;
+                        double d0 = (double)p_180533_1_.func_177958_n() + ((double)i + 0.5D) / (double)l;
+                        double d1 = (double)p_180533_1_.func_177956_o() + ((double)j + 0.5D) / (double)l;
+                        double d2 = (double)p_180533_1_.func_177952_p() + ((double)k + 0.5D) / (double)l;
                         this.func_78873_a((new EntityDiggingFX(this.field_78878_a, d0, d1, d2, d0 - (double)p_180533_1_.func_177958_n() - 0.5D, d1 - (double)p_180533_1_.func_177956_o() - 0.5D, d2 - (double)p_180533_1_.func_177952_p() - 0.5D, p_180533_2_)).func_174846_a(p_180533_1_));
                     }
                 }
@@ -372,6 +457,12 @@
         }
     }
 
+    /**
+     * Adds block hit particles for the specified block
+     *  
+     * @param pos The block's coordinates
+     * @param side The side the block was hit from
+     */
     public void func_180532_a(BlockPos p_180532_1_, EnumFacing p_180532_2_)
     {
         IBlockState iblockstate = this.field_78878_a.func_180495_p(p_180532_1_);
@@ -457,4 +548,19 @@
 
         return "" + i;
     }
+
+    public void addBlockHitEffects(BlockPos p_addBlockHitEffects_1_, MovingObjectPosition p_addBlockHitEffects_2_)
+    {
+        IBlockState iblockstate = this.field_78878_a.func_180495_p(p_addBlockHitEffects_1_);
+
+        if (iblockstate != null)
+        {
+            boolean flag = Reflector.callBoolean(iblockstate.func_177230_c(), Reflector.ForgeBlock_addHitEffects, new Object[] {this.field_78878_a, p_addBlockHitEffects_2_, this});
+
+            if (iblockstate != null && !flag)
+            {
+                this.func_180532_a(p_addBlockHitEffects_1_, p_addBlockHitEffects_2_.field_178784_b);
+            }
+        }
+    }
 }
